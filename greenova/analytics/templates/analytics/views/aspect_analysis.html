{% extends 'analytics/layouts/analytics_base.html' %}
{% load common_tags %}

{% block page_title %}{{ project.name }} - Aspect Analysis{% endblock %}
{% block page_subtitle %}Environmental Performance Analytics{% endblock %}

{% block extra_styles %}
<style>
  .aspect-grid {
    gap: 1rem;
  }

  .analytics-chart {
    min-height: 250px;
  }
</style>
{% endblock %}

{% block page_actions %}
<div class="actions">
  <button type="button" hx-get="{% url 'analytics:export_aspect_data' %}"
          class="outline">Export Analysis</button>
  <button type="button" hx-get="{% url 'analytics:refresh_aspect_data' %}"
          class="outline">Refresh Data</button>
</div>
{% endblock %}

{% block content %}
<section aria-labelledby="aspect-overview">
  <h2 id="aspect-overview">Environmental Aspects Overview</h2>

  {% if error %}
  <article role="alert">
    <p>{{ error }}</p>
  </article>
  {% else %}
  <div class="grid">
    {% for aspect in aspects %}
    <article>
      <header>
        <h3>{{ aspect.environmental_aspect }}</h3>
        <p>Total Obligations: {{ aspect.total }}</p>
      </header>

      <figure role="region" aria-label="{{ aspect.environmental_aspect }} Analytics">
        <canvas id="chart-{{ forloop.counter }}"
                data-aspect="{{ aspect.environmental_aspect }}"
                hx-get="{% url 'analytics:mechanism_status' %}?mechanism={{ aspect.environmental_aspect }}"
                hx-trigger="load"
                hx-swap="innerHTML"></canvas>
        <figcaption>Status distribution for {{ aspect.environmental_aspect }}
        </figcaption>
      </figure>

      <footer>
        <details>
          <summary>View Details</summary>
          <a href="{% url 'analytics:aspect_details' aspect.environmental_aspect %}"
             role="button"
             class="outline">
            Full Analysis
          </a>
        </details>
      </footer>
    </article>
    {% endfor %}
  </div>
  {% endif %}
</section>

{% if analytics %}
<section aria-labelledby="analytics-section">
  <h2 id="analytics-section">Performance Analytics</h2>
  {% chart_container 
   chart_id="mechanism-chart"
   title=mechanism.name
   data=chart_data
   height="300px" %}
</section>
{% endif %}
{% endblock %}

{% block sidebar %}
<nav aria-label="Aspect filters">
  <h3>Filter Options</h3>
  <!-- ...filter controls... -->
</nav>
{% endblock %}