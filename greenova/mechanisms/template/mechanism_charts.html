{% extends 'base.html' %}
{% load static common_tags %}

{% block title %}Environmental Mechanisms Analysis{% endblock %}

{% block main %}
<article>
  <header>
    <h1>Environmental Mechanisms Analysis</h1>
    <p>Analyzing obligations by primary environmental mechanisms for {{ project.name }}</p>
  </header>

  {% if error %}
  <p role="alert" class="error">{{ error }}</p>
  {% endif %}

  <section aria-labelledby="charts-title">
    <h2 id="charts-title">Mechanisms Distribution</h2>

    <div class="grid">
      {% for mechanism in mechanisms %}
      <article class="mechanism-chart">
        <header>
          <h3>{{ mechanism.name }}</h3>
          <p>Total Obligations: {{ mechanism.total }}</p>
        </header>

        <figure role="region" aria-label="{{ mechanism.name }} statistics">
          <!-- Chart canvas -->
          <canvas id="chart-{{ mechanism.id }}"
                  role="img"
                  aria-label="Status distribution for {{ mechanism.name }}"
                  data-mechanism="{{ mechanism.name }}"
                  hx-get="{% url 'mechanisms:chart_data' project.id mechanism.name %}"
                  hx-trigger="load"
                  hx-swap="none">
          </canvas>

          <!-- Fallback/accessible table -->
          <table class="chart-data">
            <caption>Status breakdown for {{ mechanism.name }}</caption>
            <thead>
              <tr>
                <th scope="col">Status</th>
                <th scope="col">Count</th>
              </tr>
            </thead>
            <tbody>
              {% for status, count in mechanism.status_counts.items %}
              <tr>
                <td>{{ status }}</td>
                <td>{{ count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </figure>
      </article>
      {% empty %}
      <p>No mechanisms data available for this project.</p>
      {% endfor %}
    </div>
  </section>
</article>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/vendor/chart.umd.js' %}" defer></script>
<script src="{% static 'js/modules/chart-manager.js' %}" type="module" defer></script>
{% endblock %}
