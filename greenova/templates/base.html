<!--
  Copyright 2025 Enveng Group.
  SPDX-License-Identifier: 	AGPL-3.0-or-later
  Base HTML template for Greenova Environmental Management System

  This template provides the core structure for all pages in the application.

  Features:
  - Responsive design using PicoCSS
  - Dark/Light theme support
  - HTMX for dynamic content loading
  - Hyperscript for client-side interactivity
  - WCAG 2.1 AA compliance
-->
{% load static %}
{% load hyperscript %}
{% load hyperscript %}
{% load django_htmx %}
{% load user_tags %}
{% load core_tags %}
<!DOCTYPE html>
<html lang="en" data-theme="light dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="color-scheme" content="light dark" />
    <meta name="keywords"
          content="environmental compliance, management system, greenova, sustainability" />
    <meta name="description"
          content="
                   {% block meta_description %}
                     Environmental Compliance Management System
                   {% endblock meta_description %}" />
    <title>

      {% block title %}

        {% block page_title %}

            greenova
        {% endblock page_title %}
      {% endblock title %}
    </title>
    <!-- Favicon -->
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon" />
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    {% block extra_head %}
    {% endblock extra_head %}
  </head>
  <body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-ext="head-support, loading-states, class-tools, path-deps"
        hx-indicator="#htmx-indicator"
        aria-live="polite">
   
    <!-- {% include "core/components/error_boundary.html" %}

 -->
    <!-- Header with semantic nav -->
    <main class="container">
    <header>
      {% block header %}
      <nav>
        <ul>
          <li>
            <img src="{% static 'img/file.ico' %}">
            <a href="{% url 'dashboard:home' %}" id="logo">
              <strong>greenova</strong>
            </a>
          </li>
          
          <!-- Breadcrumbs navigation -->
          {% if request.user.is_authenticated %}
          <li>
            <nav aria-label="breadcrumbs">
              <ul>
                {% if request.resolver_match.namespace == 'dashboard' %}
                <li>
                  <a href="{% url 'dashboard:home' %}" 
                    aria-current="{% if request.resolver_match.namespace == 'dashboard' %}page{% endif %}"
                    _="on load if location.pathname is '{% url 'dashboard:home' %}' then hide me">
                    Dashboard
                  </a>
                </li>
                {% else %}
                <li><a href="{% url 'dashboard:home' %}">Dashboard</a></li>
                {% endif %}
                
                {% block breadcrumbs %}{% endblock breadcrumbs %}
              </ul>
            </nav>
          </li>
          {% endif %}
        </ul>
        
        <ul>
          <!-- Theme toggle switcher with sun/moon icons -->
          <li>
            <button 
              id="theme-toggle" 
              aria-label="Toggle theme"
              _="on click 
                 if document.documentElement.getAttribute('data-theme') == 'light' then
                   document.documentElement.setAttribute('data-theme', 'dark')
                   localStorage.setItem('theme', 'dark')
                   set @aria-pressed to 'true'
                 else
                   document.documentElement.setAttribute('data-theme', 'light')
                   localStorage.setItem('theme', 'light')
                   set @aria-pressed to 'false'
                 end">
              <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
          </li>
          
          {% if request.user.is_authenticated %}
            <!-- Load chat widget -->
            {% load chatbot_tags %}
            {% chat_widget %}
            
            <li>
              <a href="{% url 'users:profile' %}" 
                {% if request.path == '/users/profile/' %}aria-current="page"{% endif %}>
                Profile
              </a>
            </li>
            
            {% if request.user.is_staff %}
            <li>
              <a href="{% url 'company:list' %}" 
                {% if '/company/' in request.path %}aria-current="page"{% endif %}>
                Companies
              </a>
            </li>
            {% endif %}
            
            <li>
              <a href="#"
                role="button"
                id="logout-button"
                hx-post="{% url 'account_logout' %}"
                hx-push-url="true"
                hx-target="body"
                hx-redirect="/"
                hx-include="[name='csrfmiddlewaretoken']">
                Logout
              </a>
              <form id="logout-form" style="display: none;">
                {% csrf_token %}
              </form>
            </li>
          {% else %}
            <!-- Unauthenticated user navigation -->
            <li>
              <a href="{% url 'account_signup' %}" 
                _="on load if location.pathname is '{% url 'account_signup' %}' then hide me">
                Register
              </a>
            </li>
            <li>
              <a href="{% url 'account_login' %}" 
                id="login-button"
                _="on load if location.pathname is '{% url 'account_login' %}' then hide me">
                Login
              </a>
            </li>
            <li>
              <a href="{% url 'admin:index' %}" 
                _="on load if location.pathname.startsWith('/admin/') then hide me">
                Admin
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endblock header %}
    </header>
    </main>
    <!-- After header, before main content -->
{% include "core/components/status_messages.html" %}

    <!-- Main content -->
    <main id="main-content" class="container">
      {% block body %}
        {% block content %}{% endblock content %}
      {% endblock body %}
    </main>

   <!-- Footer -->
  {% block footer %}
  <footer>
    <small>
      Â© {% now "Y" %} greenova environmental management. 
      <span id="version">version {% site_version %}</span>
    </small>
  </footer>
  {% endblock footer %}

    <!-- Loading indicator for HTMX requests -->
    <div id="htmx-indicator" class="htmx-indicator" aria-hidden="true">
      <div class="spinner">
      </div>
    </div>
    <!-- JavaScript at the end for better performance -->
    <script src="{% static 'js/vendor/htmx/htmx.min.js' %}" defer></script>
{% django_htmx_script %}
    <!-- Extensions -->
    <script src="{% static 'js/vendor/htmx/ext/head-support.min.js' %}" defer></script>
    <script src="{% static 'js/vendor/htmx/ext/loading-states.min.js' %}" defer></script>
    <script src="{% static 'js/vendor/htmx/ext/class-tools.min.js' %}" defer></script>
    <script src="{% static 'js/vendor/htmx/ext/path-deps.min.js' %}" defer></script>
    <script src="{% static 'js/vendor/_hyperscript.min.js' %}" defer></script>
    <script src="{% static 'js/app.js' %}" defer></script>
    <!-- Initialize extensions -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        htmx.config.useTemplateFragments = true;
        // Don't try to define extensions, they're already registered via the hx-ext attribute

        {% if debug %}
          if (typeof window.htmx !== "undefined") {
              htmx.on("htmx:afterSettle", function(detail) {
                  if (
                      typeof window.djdt !== "undefined"
                      && detail.target instanceof HTMLBodyElement
                  ) {
                      djdt.show_toolbar();
                  }
              });
          }
        {% endif %}
      });
    </script>
    <!-- Custom Scripts -->
    <script src="{% static 'js/components/foldable.js' %}" defer></script>
    <script src="{% static 'js/components/scrollable.js' %}" defer></script>

    {% block extra_js %}
    {% endblock extra_js %}

    <!-- Include at the end of your body section before the closing body tag -->
{% include "chatbot/chat_widget.html" %}

  </body>
</html>
